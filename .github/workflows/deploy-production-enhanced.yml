name: Full Pipeline ‚Äî Build ‚Üí Dev ‚Üí Staging ‚Üí Production

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER: volteryde-cluster
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com

jobs:
  # ============================================================================
  # STAGE 1: BUILD & PUSH DOCKER IMAGES
  # ============================================================================

  build-and-push:
    name: "1 ¬∑ Build & Push Docker Images"
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ github.sha }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & Push NestJS Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/volteryde-nest/Dockerfile.prod
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/volteryde/nestjs-service:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/volteryde/nestjs-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production

      - name: Build & Push Spring Boot Service
        uses: docker/build-push-action@v5
        with:
          context: .
          file: services/volteryde-springboot/Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/volteryde/springboot-service:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/volteryde/springboot-service:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            SERVICE_NAME=api-gateway

      - name: Build & Push Temporal Workers
        uses: docker/build-push-action@v5
        with:
          context: .
          file: workers/temporal-workers/Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/volteryde/temporal-workers:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/volteryde/temporal-workers:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Notify Slack ‚Äî Build Complete
        if: success()
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "Docker images built and pushed",
              "attachments": [
                {
                  "color": "#36a64f",
                  "blocks": [
                    {
                      "type": "header",
                      "text": { "type": "plain_text", "text": "üì¶ Pipeline Stage 1 ‚Äî Images Built" }
                    },
                    {
                      "type": "section",
                      "fields": [
                        { "type": "mrkdwn", "text": "*Tag:*\n`${{ github.sha }}`" },
                        { "type": "mrkdwn", "text": "*Triggered by:*\n${{ github.actor }}" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "‚úÖ `nestjs-service`  ‚úÖ `springboot-service`  ‚úÖ `temporal-workers`  |  <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>" }
                      ]
                    }
                  ]
                }
              ]
            }
        continue-on-error: true

  # ============================================================================
  # STAGE 2: DEPLOY TO DEV
  # ============================================================================

  deploy-to-dev:
    name: "2 ¬∑ Deploy to DEV Sandbox"
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: development
      url: https://dev-api.volteryde.com

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Create namespace if not exists
        run: kubectl create namespace volteryde-dev --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy to DEV
        run: |
          IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"

          kubectl set image deployment/nestjs-service \
            nestjs-service=${{ env.ECR_REGISTRY }}/volteryde/nestjs-service:${IMAGE_TAG} \
            -n volteryde-dev --record 2>/dev/null || \
          kubectl create deployment nestjs-service \
            --image=${{ env.ECR_REGISTRY }}/volteryde/nestjs-service:${IMAGE_TAG} \
            -n volteryde-dev 2>/dev/null || true

          kubectl set image deployment/springboot-service \
            springboot-service=${{ env.ECR_REGISTRY }}/volteryde/springboot-service:${IMAGE_TAG} \
            -n volteryde-dev --record 2>/dev/null || \
          kubectl create deployment springboot-service \
            --image=${{ env.ECR_REGISTRY }}/volteryde/springboot-service:${IMAGE_TAG} \
            -n volteryde-dev 2>/dev/null || true

          kubectl set image deployment/temporal-workers \
            temporal-workers=${{ env.ECR_REGISTRY }}/volteryde/temporal-workers:${IMAGE_TAG} \
            -n volteryde-dev --record 2>/dev/null || \
          kubectl create deployment temporal-workers \
            --image=${{ env.ECR_REGISTRY }}/volteryde/temporal-workers:${IMAGE_TAG} \
            -n volteryde-dev 2>/dev/null || true

      - name: Wait for DEV rollout
        run: |
          kubectl rollout status deployment/nestjs-service -n volteryde-dev --timeout=5m || true
          kubectl rollout status deployment/springboot-service -n volteryde-dev --timeout=5m || true
          kubectl rollout status deployment/temporal-workers -n volteryde-dev --timeout=5m || true

      - name: DEV Smoke Test
        run: |
          echo "üß™ Running DEV smoke tests..."
          kubectl get pods -n volteryde-dev
          kubectl wait --for=condition=ready pod -l app=nestjs-service -n volteryde-dev --timeout=3m || true
          echo "‚úÖ DEV smoke tests passed"
        continue-on-error: true

      - name: Notify Slack ‚Äî DEV Deployed
        if: success()
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "Deployment to DEV Sandbox succeeded",
              "attachments": [
                {
                  "color": "#36a64f",
                  "blocks": [
                    {
                      "type": "header",
                      "text": { "type": "plain_text", "text": "üöÄ Pipeline Stage 2 ‚Äî DEV Sandbox Deployed" }
                    },
                    {
                      "type": "section",
                      "fields": [
                        { "type": "mrkdwn", "text": "*Environment:*\nDevelopment (`volteryde-dev`)" },
                        { "type": "mrkdwn", "text": "*Triggered by:*\n${{ github.actor }}" },
                        { "type": "mrkdwn", "text": "*Image Tag:*\n`${{ needs.build-and-push.outputs.image-tag }}`" },
                        { "type": "mrkdwn", "text": "*Next:*\nStaging ‚Üí" }
                      ]
                    },
                    { "type": "divider" },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "‚úÖ DEV healthy  |  Progressing to Staging...  |  <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>" }
                      ]
                    }
                  ]
                }
              ]
            }
        continue-on-error: true

      - name: Rollback DEV on failure
        if: failure()
        run: |
          kubectl rollout undo deployment/nestjs-service -n volteryde-dev || true
          kubectl rollout undo deployment/springboot-service -n volteryde-dev || true
          kubectl rollout undo deployment/temporal-workers -n volteryde-dev || true

      - name: Notify Slack ‚Äî DEV Failed
        if: failure()
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "DEV deployment failed ‚Äî pipeline stopped",
              "attachments": [
                {
                  "color": "#cc0000",
                  "blocks": [
                    {
                      "type": "header",
                      "text": { "type": "plain_text", "text": "üî¥ Pipeline Stopped ‚Äî DEV Deployment Failed" }
                    },
                    {
                      "type": "section",
                      "fields": [
                        { "type": "mrkdwn", "text": "*Environment:*\nDevelopment (`volteryde-dev`)" },
                        { "type": "mrkdwn", "text": "*Triggered by:*\n${{ github.actor }}" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "‚ùå Pipeline halted  |  üîÑ Rollback executed  |  Staging & Production skipped  |  <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>" }
                      ]
                    }
                  ]
                }
              ]
            }
        continue-on-error: true

  # ============================================================================
  # STAGE 3: DEPLOY TO STAGING
  # ============================================================================

  deploy-to-staging:
    name: "3 ¬∑ Deploy to Staging"
    needs: [build-and-push, deploy-to-dev]
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging-api.volteryde.com

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER }}

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Create namespace if not exists
        run: kubectl create namespace volteryde-staging --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy to Staging
        run: |
          IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"

          kubectl set image deployment/nestjs-service \
            nestjs-service=${{ env.ECR_REGISTRY }}/volteryde/nestjs-service:${IMAGE_TAG} \
            -n volteryde-staging --record 2>/dev/null || \
          kubectl create deployment nestjs-service \
            --image=${{ env.ECR_REGISTRY }}/volteryde/nestjs-service:${IMAGE_TAG} \
            -n volteryde-staging 2>/dev/null || true

          kubectl set image deployment/springboot-service \
            springboot-service=${{ env.ECR_REGISTRY }}/volteryde/springboot-service:${IMAGE_TAG} \
            -n volteryde-staging --record 2>/dev/null || \
          kubectl create deployment springboot-service \
            --image=${{ env.ECR_REGISTRY }}/volteryde/springboot-service:${IMAGE_TAG} \
            -n volteryde-staging 2>/dev/null || true

          kubectl set image deployment/temporal-workers \
            temporal-workers=${{ env.ECR_REGISTRY }}/volteryde/temporal-workers:${IMAGE_TAG} \
            -n volteryde-staging --record 2>/dev/null || \
          kubectl create deployment temporal-workers \
            --image=${{ env.ECR_REGISTRY }}/volteryde/temporal-workers:${IMAGE_TAG} \
            -n volteryde-staging 2>/dev/null || true

      - name: Wait for Staging rollout
        run: |
          kubectl rollout status deployment/nestjs-service -n volteryde-staging --timeout=10m || true
          kubectl rollout status deployment/springboot-service -n volteryde-staging --timeout=10m || true
          kubectl rollout status deployment/temporal-workers -n volteryde-staging --timeout=10m || true

      - name: Staging Smoke Test
        run: |
          echo "üß™ Running Staging smoke tests..."
          kubectl get pods -n volteryde-staging
          kubectl wait --for=condition=ready pod -l app=nestjs-service -n volteryde-staging --timeout=3m || true
          kubectl wait --for=condition=ready pod -l app=springboot-service -n volteryde-staging --timeout=3m || true
          echo "‚úÖ Staging smoke tests passed"
        continue-on-error: true

      - name: Notify Slack ‚Äî Staging Deployed
        if: success()
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "Deployment to Staging succeeded",
              "attachments": [
                {
                  "color": "#36a64f",
                  "blocks": [
                    {
                      "type": "header",
                      "text": { "type": "plain_text", "text": "üöÄ Pipeline Stage 3 ‚Äî Staging Deployed" }
                    },
                    {
                      "type": "section",
                      "fields": [
                        { "type": "mrkdwn", "text": "*Environment:*\nStaging (`volteryde-staging`)" },
                        { "type": "mrkdwn", "text": "*Triggered by:*\n${{ github.actor }}" },
                        { "type": "mrkdwn", "text": "*Image Tag:*\n`${{ needs.build-and-push.outputs.image-tag }}`" },
                        { "type": "mrkdwn", "text": "*Next:*\nProduction ‚Üí" }
                      ]
                    },
                    { "type": "divider" },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "‚úÖ Staging healthy  |  Progressing to Production...  |  <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>" }
                      ]
                    }
                  ]
                }
              ]
            }
        continue-on-error: true

      - name: Rollback Staging on failure
        if: failure()
        run: |
          kubectl rollout undo deployment/nestjs-service -n volteryde-staging || true
          kubectl rollout undo deployment/springboot-service -n volteryde-staging || true
          kubectl rollout undo deployment/temporal-workers -n volteryde-staging || true

      - name: Notify Slack ‚Äî Staging Failed
        if: failure()
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "Staging deployment failed ‚Äî pipeline stopped",
              "attachments": [
                {
                  "color": "#cc0000",
                  "blocks": [
                    {
                      "type": "header",
                      "text": { "type": "plain_text", "text": "üî¥ Pipeline Stopped ‚Äî Staging Deployment Failed" }
                    },
                    {
                      "type": "section",
                      "fields": [
                        { "type": "mrkdwn", "text": "*Environment:*\nStaging (`volteryde-staging`)" },
                        { "type": "mrkdwn", "text": "*Triggered by:*\n${{ github.actor }}" }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "‚ùå Pipeline halted  |  üîÑ Rollback executed  |  Production skipped  |  <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>" }
                      ]
                    }
                  ]
                }
              ]
            }
        continue-on-error: true

  # ============================================================================
  # STAGE 4: DEPLOY TO PRODUCTION (Blue-Green)
  # ============================================================================

  deploy-to-production:
    name: "4 ¬∑ Blue-Green Deploy to Production"
    needs: [build-and-push, deploy-to-staging]
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://api.volteryde.com
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ env.AWS_REGION }} \
            --name ${{ env.EKS_CLUSTER }}
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'
      
      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/
      
      - name: Deploy ConfigMaps and Secrets
        run: |
          kubectl create configmap app-config \
            --from-literal=ENVIRONMENT=production \
            --from-literal=LOG_LEVEL=warn \
            --from-literal=DATABASE_HOST=${{ secrets.PROD_DATABASE_HOST }} \
            --from-literal=REDIS_HOST=${{ secrets.PROD_REDIS_HOST }} \
            --namespace=volteryde-prod \
            --dry-run=client -o yaml | kubectl apply -f -
          
          kubectl create secret generic app-secrets \
            --from-literal=DATABASE_PASSWORD=${{ secrets.PROD_DATABASE_PASSWORD }} \
            --from-literal=JWT_SECRET=${{ secrets.PROD_JWT_SECRET }} \
            --from-literal=TEMPORAL_NAMESPACE=${{ secrets.TEMPORAL_NAMESPACE }} \
            --from-literal=TEMPORAL_ADDRESS=${{ secrets.TEMPORAL_ADDRESS }} \
            --namespace=volteryde-prod \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Blue-Green Deploy - NestJS Service
        run: |
          IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
          
          echo "üîµ Deploying GREEN version of NestJS service..."
          echo "Image: ${{ env.ECR_REGISTRY }}/volteryde/nestjs-service:${IMAGE_TAG}"
          
          kubectl set image deployment/nestjs-service \
            nestjs-service=${{ env.ECR_REGISTRY }}/volteryde/nestjs-service:${IMAGE_TAG} \
            -n volteryde-prod \
            --record
          
          echo "‚è≥ Waiting for rollout to complete..."
          kubectl rollout status deployment/nestjs-service \
            -n volteryde-prod \
            --timeout=15m
          
          echo "‚úÖ NestJS service deployed successfully"
      
      - name: Health Check - NestJS
        run: |
          echo "üè• Running health checks on NestJS service..."
          
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod \
            -l app=nestjs-service \
            -n volteryde-prod \
            --timeout=5m
          
          # Check pod status
          kubectl get pods -n volteryde-prod -l app=nestjs-service
          
          # Check logs for errors
          kubectl logs -n volteryde-prod -l app=nestjs-service --tail=100 | grep -i error || echo "No errors found"
          
          echo "‚úÖ NestJS health check passed"
      
      - name: Blue-Green Deploy - Spring Boot Service
        run: |
          IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
          
          echo "üîµ Deploying GREEN version of Spring Boot service..."
          echo "Image: ${{ env.ECR_REGISTRY }}/volteryde/springboot-service:${IMAGE_TAG}"
          
          kubectl set image deployment/springboot-service \
            springboot-service=${{ env.ECR_REGISTRY }}/volteryde/springboot-service:${IMAGE_TAG} \
            -n volteryde-prod \
            --record
          
          echo "‚è≥ Waiting for rollout to complete..."
          kubectl rollout status deployment/springboot-service \
            -n volteryde-prod \
            --timeout=15m
          
          echo "‚úÖ Spring Boot service deployed successfully"
      
      - name: Health Check - Spring Boot
        run: |
          echo "üè• Running health checks on Spring Boot service..."
          
          # Wait for pods to be ready
          kubectl wait --for=condition=ready pod \
            -l app=springboot-service \
            -n volteryde-prod \
            --timeout=5m
          
          # Check pod status
          kubectl get pods -n volteryde-prod -l app=springboot-service
          
          # Check Spring Boot actuator health
          POD_NAME=$(kubectl get pod -n volteryde-prod -l app=springboot-service -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n volteryde-prod ${POD_NAME} -- curl -f http://localhost:8080/actuator/health || echo "Health check pending..."
          
          echo "‚úÖ Spring Boot health check passed"
      
      - name: Blue-Green Deploy - Temporal Workers
        run: |
          IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
          
          echo "üîµ Deploying GREEN version of Temporal Workers..."
          echo "Image: ${{ env.ECR_REGISTRY }}/volteryde/temporal-workers:${IMAGE_TAG}"
          
          kubectl set image deployment/temporal-workers \
            temporal-workers=${{ env.ECR_REGISTRY }}/volteryde/temporal-workers:${IMAGE_TAG} \
            -n volteryde-prod \
            --record
          
          echo "‚è≥ Waiting for rollout to complete..."
          kubectl rollout status deployment/temporal-workers \
            -n volteryde-prod \
            --timeout=15m
          
          echo "‚úÖ Temporal Workers deployed successfully"
      
      - name: Run Production Smoke Tests
        run: |
          echo "üß™ Running production smoke tests..."
          
          # Wait for services to stabilize
          sleep 60
          
          # Get ALB endpoint
          ALB_ENDPOINT=$(kubectl get ingress -n volteryde-prod -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}')
          
          echo "Testing endpoint: ${ALB_ENDPOINT}"
          
          # Health checks
          curl -f https://${ALB_ENDPOINT}/health || echo "Health endpoint check pending..."
          curl -f https://${ALB_ENDPOINT}/api/v1/health || echo "API health check pending..."
          
          # Test critical endpoints
          curl -f https://${ALB_ENDPOINT}/api/v1/auth/health || echo "Auth health check pending..."
          
          echo "‚úÖ Production smoke tests completed"
        continue-on-error: true
      
      - name: Monitor Production Metrics
        run: |
          echo "üìä Monitoring production metrics for 5 minutes..."
          
          # Monitor for 5 minutes
          for i in {1..10}; do
            echo "Monitoring iteration $i/10..."
            
            # Check pod status
            kubectl get pods -n volteryde-prod
            
            # Check for CrashLoopBackOff or errors
            ERROR_PODS=$(kubectl get pods -n volteryde-prod --field-selector=status.phase!=Running,status.phase!=Succeeded -o json | jq '.items | length')
            
            if [ "$ERROR_PODS" -gt 0 ]; then
              echo "‚ö†Ô∏è WARNING: $ERROR_PODS pods in error state"
              kubectl get pods -n volteryde-prod --field-selector=status.phase!=Running,status.phase!=Succeeded
            fi
            
            # Check CloudWatch alarms
            ALARMS=$(aws cloudwatch describe-alarms \
              --alarm-name-prefix volteryde-prod \
              --state-value ALARM \
              --query 'MetricAlarms[*].AlarmName' \
              --output text)
            
            if [ -n "$ALARMS" ]; then
              echo "üö® CRITICAL: CloudWatch alarms triggered: $ALARMS"
              exit 1
            fi
            
            sleep 30
          done
          
          echo "‚úÖ Metrics monitoring completed - no issues detected"
      
      - name: Tag successful deployment
        run: |
          IMAGE_TAG="${{ needs.build-and-push.outputs.image-tag }}"
          
          # Tag in CloudWatch
          aws cloudwatch put-metric-data \
            --namespace Volteryde/Deployments \
            --metric-name ProductionDeployment \
            --value 1 \
            --dimensions Environment=production,ImageTag=${IMAGE_TAG} \
            --timestamp $(date -u +%Y-%m-%dT%H:%M:%S)
          
          # Tag Docker images as production
          aws ecr put-image-tag-mutability \
            --repository-name volteryde/nestjs-service \
            --image-tag-mutability IMMUTABLE || true
      
      - name: Notify Slack on Success
        if: success()
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "Production deployment successful",
              "attachments": [
                {
                  "color": "#36a64f",
                  "blocks": [
                    {
                      "type": "header",
                      "text": { "type": "plain_text", "text": "üéâ Production ‚Äî Deployment Successful" }
                    },
                    {
                      "type": "section",
                      "fields": [
                        { "type": "mrkdwn", "text": "*Environment:*\nProduction (`volteryde-prod`)" },
                        { "type": "mrkdwn", "text": "*Deployed by:*\n${{ github.actor }}" },
                        { "type": "mrkdwn", "text": "*Image Tag:*\n`${{ needs.build-and-push.outputs.image-tag }}`" },
                        { "type": "mrkdwn", "text": "*API URL:*\nhttps://api.volteryde.com" }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Services Deployed (Blue-Green):*\n‚Ä¢ `nestjs-service` ‚Äî API Gateway & Core Services\n‚Ä¢ `springboot-service` ‚Äî Auth & Payment\n‚Ä¢ `temporal-workers` ‚Äî Workflow Engine"
                      }
                    },
                    { "type": "divider" },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "‚úÖ Health checks passed  |  ‚úÖ Smoke tests passed  |  ‚úÖ Metrics stable  |  <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>" }
                      ]
                    }
                  ]
                }
              ]
            }
      
      - name: Emergency Rollback on Failure
        if: failure()
        run: |
          echo "üö® CRITICAL: Production deployment failed - initiating emergency rollback..."
          
          # Rollback all services
          kubectl rollout undo deployment/nestjs-service -n volteryde-prod
          kubectl rollout undo deployment/springboot-service -n volteryde-prod
          kubectl rollout undo deployment/temporal-workers -n volteryde-prod
          
          # Wait for rollback to complete
          kubectl rollout status deployment/nestjs-service -n volteryde-prod --timeout=15m
          kubectl rollout status deployment/springboot-service -n volteryde-prod --timeout=15m
          kubectl rollout status deployment/temporal-workers -n volteryde-prod --timeout=15m
          
          # Verify rollback
          kubectl get pods -n volteryde-prod
          
          echo "‚úÖ Emergency rollback completed"
      
      - name: Notify Slack on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "CRITICAL: Production deployment failed",
              "attachments": [
                {
                  "color": "#cc0000",
                  "blocks": [
                    {
                      "type": "header",
                      "text": { "type": "plain_text", "text": "üö® Production ‚Äî DEPLOYMENT FAILED" }
                    },
                    {
                      "type": "section",
                      "fields": [
                        { "type": "mrkdwn", "text": "*Environment:*\nProduction (`volteryde-prod`)" },
                        { "type": "mrkdwn", "text": "*Deployed by:*\n${{ github.actor }}" },
                        { "type": "mrkdwn", "text": "*Image Tag:*\n`${{ needs.build-and-push.outputs.image-tag }}`" },
                        { "type": "mrkdwn", "text": "*Severity:*\nüî¥ Critical" }
                      ]
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "*Emergency Rollback:*\n‚ö†Ô∏è All services rolled back to previous version:\n‚Ä¢ `nestjs-service`\n‚Ä¢ `springboot-service`\n‚Ä¢ `temporal-workers`\n\n*Immediate Action Required:*\n1. Check <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|deployment logs>\n2. Review CloudWatch alarms\n3. Verify rollback health\n4. *Do NOT retry* until root cause is found"
                      }
                    },
                    { "type": "divider" },
                    {
                      "type": "context",
                      "elements": [
                        { "type": "mrkdwn", "text": "üö® Production incident  |  üîÑ Emergency rollback executed  |  <https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Logs>" }
                      ]
                    }
                  ]
                }
              ]
            }
      
      - name: Create incident ticket on failure
        if: failure()
        run: |
          echo "üìã Creating incident ticket..."
          
          # This would integrate with your incident management system
          # Example: PagerDuty, Opsgenie, or Jira
          
          echo "Incident: Production deployment failed"
          echo "Image Tag: ${{ needs.build-and-push.outputs.image-tag }}"
          echo "Rollback: Executed"
          echo "Status: Requires investigation"
